name: Azure CI/CD

on:
    push:
        branches:
            - azure-prod
    workflow_dispatch:

jobs:
    setup:
        name: Build and Deploy Job
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3
            
            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                node-version: '20'

            - name: Install dependencies
              run: npm install
              working-directory: my-portfolio
            
            - name: Build
              run: npm run build
              working-directory: my-portfolio

            - name: Azure Login
              uses: azure/login@v1
              with:
                creds: ${{ secrets.AZURE_CREDENTIALS }}
            
            - name: Deploy Infrastructure
              uses: azure/arm-deploy@v1
              with:
                scope: subscription
                subscriptionId: ${{ vars.AZURE_SUBSCRIPTION_ID }}
                region: ${{ vars.AZURE_REGION }}
                template: ./my-portfolio/Azure/main.bicep
                failOnStdErr: false
                parameters: |
                  location=${{ vars.AZURE_REGION }}
                  resourceGroupName=${{ vars.AZURE_RESOURCE_GROUP_NAME }}
                  sku=Free
                  linuxFxVersion='node|20-lts'
                  webAppName='portfolio-appservice'

            - name: Zip site contents
              run: |
                cd my-portfolio
                zip -r ../app.zip .next public package.json package-lock.json
              shell: bash

            - name: Deploy to Azure App Service
              uses: azure/webapps-deploy@v2
              with:
                app-name: 'wapp-portfolio-appservice'
                slot-name: 'production'
                publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
                package: ./app.zip
